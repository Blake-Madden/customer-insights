---
title: Push notification device registration setup for application developers
description: Learn developer settings for registering push notification devices in Dynamics 365 Customer Insights - Journeys.
ms.date: 09/08/2023
ms.topic: article
author: alfergus
ms.author: alfergus
search.audienceType: 
  - admin
  - customizer
  - enduser
---

# Push notification device registration for application developers

To learn more about the overall approach to setting up push notifications in Customer Insights - Journeys, visit the [Push notification setup overview](real-time-marketing-push-setup-overview.md).

To enable push notifications in Customer Insights - Journeys, you need to complete the following steps:

1. [Push notification application configuration](real-time-marketing-push-notification-setup.md)
1. [User mapping for push notifications](real-time-marketing-push-user-mapping.md)
1. [Device registration for push notifications](real-time-marketing-developer-push.md)
1. [Receiving push notifications on devices](real-time-marketing-developer-notifications.md)
1. [Interaction reporting for push notifications](real-time-marketing-developer-push-interactions.md)

This diagram describes the two steps necessary to register devices and users within Customer Insights - Journeys.

> [!div class="mx-imgBorder"]
> ![Push notifications device and user registration diagram.](media/real-time-marketing-push-user-registration.png "Push notifications device and user registration diagram")

## Device registration

To complete the mobile app configuration, the developer must register devices across servers. You should already have the device token, user ID from CI-J (contact ID, lead ID, customer insights profile ID), and mobile application ID from CI-J.

Upon successful call of a device registration request, there will be a 202 response. This only indicates the request was accepted. To confirm a successful request, you need to check the status. You can do this through using a webhook or calling the status endpoint directly.

### API

#### Device Registration (single):

Sample HTTP Request:

```HTTP
POST {PublicEndpoint}/api/v1.0/orgs/%ORG_ID%/pushdeviceregistration/devices
```

```JSON
{
    "MobileAppId": "00000000-0000-0000-0000-000000000000",
    "UserId": "00000000-0000-0000-0000-000000000000",
    "ApiToken": "%API_TOKEN%",
    "ApnsDeviceToken": "%APNS_TOKEN%"
}
```

Headers:

- **x-ms-track-registration:** when true, the information about registration success/failure will be stored and be available through registration status API
- **x-ms-callback-url:** When not empty, failed or successful device registration will trigger POST request webhook.
- **x-ms-callback-url-headers:** Contains a serialized JSON of a string-to-string dictionary, representing headers passed for webhook requests. Used only when x-ms-callback-url is defined.

Returns: 202 if provided request is valid, 400 otherwise.

Response Body:

When **x-ms-track-registration** is true:

```JSON
{
    "RegistrationRequestId": "%GUID%"
}
```

Otherwise, empty body

#### Definitions

|Name|Description|
|---|---|
|MobileAppId| This is the identifier of the mobile application configured in Customer Insights - Journeys|
|UserId| This is the user identifier of the contact, lead, or CI Profile from Customer Insights - Journeys|
|ApiToken| This is your API token to authorize the request|
|ApnsDeviceToken| This is the unique device token identifier generated by the application|

#### Device Registration (multiple)

The body of the batch registration contains an array of up to 100 objects representing device registration requests.

```HTTP
POST {PublicEndpoint}/api/v1.0/orgs/%ORG_ID%/pushdeviceregistration/devices/batch
```

```JSON
[
    {
        "MobileAppId": "00000000-0000-0000-0000-000000000000",      
        "UserId": "00000000-0000-0000-0000-000000000000",
        "ApiToken": "%API_TOKEN%",
        "ApnsDeviceToken": "%APNS_TOKEN%"
    },
    {
        "MobileAppId": "00000000-0000-0000-0000-000000000000",
        "UserId": "00000000-0000-0000-0000-000000000000",
        "ApiToken": "%API_TOKEN%",
        "ApnsDeviceToken": "%APNS_TOKEN%"
    }
]
```

Headers:

- **x-ms-track-registration:** when true, the information about registration success/failure will be stored and be available through registration status API
- **x-ms-callback-url:** When not empty, failed or successful device registration will trigger POST request webhook.
- **x-ms-callback-url-headers:** Contains a serialized JSON of a string-to-string dictionary, representing headers passed for webhook requests. Used only when x-ms-callback-url is defined.

Returns: 202 if provided request is valid, 400 otherwise.

Response Body:

When **x-ms-track-registration** is true: an array of items, each item order corresponds to order from the request body array.

```JSON
[
    {
        "RegistrationRequestId": "%REG_REQUEST_ID%"
    },
    {
        "RegistrationRequestId": "%REG_REQUEST_ID%"
    }
]
```

Otherwise, empty body.

#### Device Registration Status

```HTTP
GET  https://public-eur.mkt.dynamics.com/api/v1.0/orgs/%ORG_ID%/pushdeviceregistration/devices/status/batch
```

Request Body: array of up to 100 items
```JSON
[
    {
        "RegistrationRequestId": "%REG_REQUEST_ID%",
        "ApiToken": "%API_TOKEN%"
    }
]
```

Returns: 202 if provided request is valid, 400 otherwise.

Response Body: an array of items:

```JSON
{
    "Status": "Pending|Success|Failed",
    "FailureReason": " DuplicateExists|DryRunSendingFailed|DeviceTokenTooLong|FailedToStoreDevice|ApiTokenNotValid " // dry run sending is a verification of device token by sending an invisible notification to mobile app. Such sending failure might happen due to a wrong device token or incorrect/expired mobile app auth data
}
```

Each item order corresponds to the order from request body array

Important note - there might be two reasons when Status might stuck in “Pending” state:

1. Original device registration request had invalid API token. To prevent a possibility for malicious actors to perform DoS attack against CRM environment by calling “register device” and cause infinite CDS throttling, such attempts will not produce storing of registration history, hence no info to check success
1. CRM stays in throttled state for multiple hours, making the status update operation to fail executing its job after multiple retries
1. Device registration request was made without x-ms-track-registration header provided

#### Device Registration Status Webhook

Whenever a device registration is successful or failed if an x-ms-status-callback-url is provided the URL value of this header will be accessed by Customer Insights - Journeys.

POST to URL provided within **x-ms-status-callback-url** header of device registration request

Body:

```JSON
{ 
    "Status": "Success|Failed", 
    "Signature": "%SIGNATURE%", 
    "FailureReason": " DuplicateExists|DryRunSendingFailed|DeviceTokenTooLong|FailedToStoreDevice|ApiTokenNotValid" 
} 
```

**Note #1**: Signature is HMACSHA256 hash of callback URL calculated using API token as a key. Can be used to verify that the call was indeed made by the CRM organization. This can be done by hashing the callback URL with the API token on the webhook’s side, using the same algorithm, and comparing the values.

**Note #2:** Attempt to make a request will be made only once. Any failure to execute a request, such as an incorrect callback URL, REST API call timeout, or unexpected response status code will cause the notification to be lost.

Returns: 202 if provided request is valid, 400 otherwise.

Expected Body: Empty body

#### Device Cleanup (single)

It is important to remove devices that are no longer valid from the database to ensure performant message sending. Use the following approach to remove old device, user, application combinations from the devices table.

```HTTP
POST {PublicEndpoint}/api/v1.0/orgs/%ORG_ID%/pushdeviceregistration/devices/cleanup
```

```JSON
{
    "MobileAppId": "00000000-0000-0000-0000-000000000000",
    "ApiToken": "%API_TOKEN%",
    "UserId": "00000000-0000-0000-0000-000000000000",
    "DeviceToken": "%OPTIONAL_FCM_OR_APNS_DEVICE_TOKEN% )"
}
```

Returns: 202 if provided request is valid, 400 otherwise.

#### Definitions

|Name|Description|
|---|---|
|MobileAppId| This is the identifier of the mobile application configured in Customer Insights - Journeys|
|ApiToken| This is your API token to authorize the request|
|UserId| This is the user identifier of the contact, lead, or CI Profile from Customer Insights - Journeys|
|DeviceToken|This is the unique device token identifier generated by the application|

#### Device Cleanup (multiple)

It is important to remove devices that are no longer valid from the database to ensure performant message sending. Use the following approach to remove old device, user, application combinations from the devices table.

```HTTP
POST {PublicEndpoint}/api/v1.0/orgs/%ORG_ID%/pushdeviceregistration/devices/cleanup/batch
```

```JSON
{
    "MobileAppId": "00000000-0000-0000-0000-000000000000",
    "ApiToken": "%API_TOKEN%",
    "UserId": "00000000-0000-0000-0000-000000000000",
    "DeviceToken": "%OPTIONAL_FCM_OR_APNS_DEVICE_TOKEN% )"
}
```

Returns: 202 if provided request is valid, 400 otherwise.

---

[!INCLUDE [footer-include](./includes/footer-banner.md)]